<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace = "com.soodagram.soodagram.mappers.feed.FeedMapper">
	
	<resultMap id="FeedResultMap" type="FeedVO">
		<id property="feedNo" column="feed_no"/>
		<result property="content" column="content" />
		<result property="regDate" column="reg_date" />
		<result property="updateDate" column="update_date" />
		<result property="userEmail" column="user_email" />
		<result property="userId" column="user_id" />	
		<result property="userImg" column="user_img"/>
		<collection property="fileVO" javaType="java.util.ArrayList" resultMap="FileResultMap"/>
	</resultMap>
	
	<resultMap id="FileResultMap" type="FileVO">
		<id property="fileName" column="file_name" />
		<result property="feedNo" column="feed_no" />
		<result property="regDate" column="reg_date" />
	</resultMap>	
	
	<!-- Feed 등록 -->
	<insert id="writeFeed" parameterType="hashMap">
		
		INSERT INTO tbl_feed (
			content,
			user_email
		) VALUES (
			#{content},
			#{userEmail}
		)		
		<!-- 다른 테이블 참조하기 위해, auto_increment 값을 Insert 한 후, 반환하여 사용할 수 있도록 selectkey 사용 -->
		<selectKey resultType="int" keyProperty="feedNo" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
		
	</insert>

	<!-- 본인 피드 정보 받기 -->
	<select id="getMyFeed" parameterType="UserVO" resultMap="FeedResultMap">
		<![CDATA[
			SELECT
				feed.feed_no,
				feed.content,
				feed.reg_date,
				feed.update_date,
				feed.user_email,
				file.file_name
			FROM
				tbl_feed as feed
			LEFT JOIN tbl_feed_img as file
			ON  (feed.feed_no = file.feed_no)
			WHERE
				feed.user_email = #{userEmail}	
			ORDER BY reg_date DESC, update_date DESC			
		]]>
	</select>

	<!-- 팔로잉 하는 유저의 초기 피드 받아오기 -->
	<select id="getFollowingFeed" parameterType="UserVO" resultMap="FeedResultMap">
		<![CDATA[
			SELECT
				feed.feed_no,
				feed.content,
				feed.reg_date,
				feed.update_date,
				feed.user_email,
				tu.user_id,
				tu.user_img,
				tfi.file_name
			FROM
				tbl_feed as feed
			INNER JOIN tbl_feed_img as tfi
			ON  feed.feed_no = tfi.feed_no
			INNER JOIN tbl_user AS tu
			ON feed.user_email = tu.user_email
			LEFT JOIN tbl_user_follow AS tuf
			ON feed.user_email = tuf.target_user
			WHERE
				tuf.based_user = #{userEmail}
			ORDER BY feed_no DESC, update_date DESC
		]]>
	</select>
	
	<!-- 스크롤 피드 수신 -->
	<select id="getMoreFeed" parameterType="hashMap" resultMap="FeedResultMap">
		<![CDATA[
			SELECT
				feed.feed_no,
				feed.content,
				feed.reg_date,
				feed.update_date,
				feed.user_email,
				tu.user_id,
				tu.user_img,
				tfi.file_name
			FROM
				tbl_feed as feed
			INNER JOIN tbl_feed_img as tfi
			ON  feed.feed_no = tfi.feed_no
			INNER JOIN tbl_user AS tu
			ON feed.user_email = tu.user_email
			LEFT JOIN tbl_user_follow AS tuf
			ON feed.user_email = tuf.target_user
			WHERE
				tuf.based_user = #{user.userEmail}
				AND feed.feed_no > #{minFeedNo}
			ORDER BY feed_no DESC, update_date DESC
			LIMIT 0, 5
		]]>
	</select>
	

</mapper>